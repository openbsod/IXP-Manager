<?php

namespace Database\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema as Schema;
use D2EM;

class Version20170220204719 extends AbstractMigration
{
    /**
     * @param Schema $schema
     */
    public function up(Schema $schema) {
        $this->abortIf( $this->connection->getDatabasePlatform()->getName() != 'mysql', 'Migration can only be executed safely on \'mysql\'.' );

        $this->addSql( 'ALTER TABLE virtualinterface ADD lag_framing TINYINT(1) DEFAULT \'0\' NOT NULL' );
    }


    /**
     * @param Schema $schema
     */
    public function postUp( Schema $schema ) {
        parent::postUp( $schema ); // TODO: Change the autogenerated stub

        // need to set lag_framing on all ports with >1 physical interface
        foreach( D2EM::getRepository('Entities\VirtualInterface')->findAll() as $vi ) {
            /** @var \Entities\VirtualInterface $vi */
            if( count( $vi->getPhysicalInterfaces() ) > 1 ) {
                $vi->setLagFraming(true);
                D2EM::flush();
            }
        }
    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        $this->abortIf($this->connection->getDatabasePlatform()->getName() != 'mysql', 'Migration can only be executed safely on \'mysql\'.');

        $this->addSql('ALTER TABLE virtualinterface DROP lag_framing');
    }
}
